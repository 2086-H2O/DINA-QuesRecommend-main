import pandas as pd
import numpy as np

file_path = "/Users/gantaotao/Documents/Develop2086/DINA-QuesRecommend/DINA-QuesRecommend-main/Artificial_Q_process/çŸ¥è¯†ç‚¹äººå·¥(1).xlsx"

from collections import Counter

def load_and_validate_mapping():
    """åŠ è½½å¹¶éªŒè¯æ˜ å°„è§„åˆ™"""
    # ==============================================================================
# ä¼˜åŒ–ç‰ˆæ˜ å°„è§„åˆ™ (Optimized Strategy 4 Mapping)
# é€»è¾‘å˜æ›´ç‚¹ï¼š
# 1. [å®éªŒå·¥è‰º] ä¸ [ç”µæ°”å®‰å…¨] å½»åº•åˆ†å®¶ï¼Œä¸å†æ··æ·†â€œæ‰‹ç¬¨â€å’Œâ€œè¿è§„â€ã€‚
# 2. [ä¸‰ç›¸åŠŸç‡] ä¸ [é¢‘ç‡å“åº”] å½»åº•åˆ†å®¶ï¼Œç†æ¸…å¼ºç”µä¸å¼±ç”µè¾¹ç•Œã€‚
# 3. [åŸºç¡€ç†è®º] å¤§æ¡¶è¿›è¡Œäº†â€œç˜¦èº«â€ï¼Œå°†æ³¢å½¢ã€ç”µæºç­‰å…·ä½“åº”ç”¨åˆ†å‘åˆ°äº†å¯¹åº”ç±»ç›®ã€‚
# ==============================================================================

    mapping_rules = {
        # ---------------- L1: ç‰©ç†åŸå­ä¸ç†è®º ----------------
        "L1_ç”µè·¯ç†è®ºåŸºç¡€": [
            "ç”µè·¯åŸºæœ¬æ¦‚å¿µ", "ç”µè·¯åŸºæœ¬æ¦‚å¿µä¸å®šå¾‹", "ç”µè·¯åŸºç¡€ç†è®ºä¸å…ƒå™¨ä»¶", "ç”µè·¯åŸºç¡€ç†è®ºä¸åˆ†æ", 
            "ç”µè·¯ç†è®ºä¸åˆ†ææ–¹æ³•", "ç”µè·¯åŸç†ä¸åˆ†æ", "ç”µè·¯åˆ†æä¸è®¡ç®—", "ç”µè·¯å“åº”ä¸ç‰¹æ€§åˆ†æ", 
            "ç”µè·¯ç‰¹æ€§ä¸åˆ†æ", "ç”µè·¯å‚æ•°ä¸è´Ÿè½½ç‰¹æ€§", "ç”µè·¯å‚æ•°è®¡ç®—ä¸è¯¯å·®åˆ†æ", "ç”µè·¯ç­‰æ•ˆä¸ç®€åŒ–", 
            "ç”µè·¯è¿æ¥ä¸æ‹“æ‰‘", "åŸºæœ¬ç”µè·¯åˆ†ææ–¹æ³•", "ç”µå­¦åŸºæœ¬ç‰©ç†é‡ä¸æµ‹é‡", "ç”µå·¥ç”µå­åŸºæœ¬æ¦‚å¿µä¸ç‰©ç†é‡", 
            "åŸºç¡€ç”µå­¦ä¸ç‰©ç†æ¦‚å¿µ", "åŸºæœ¬ç”µå‚æ•°æµ‹é‡", "è´Ÿè½½ç‰¹æ€§ä¸è¿æ¥", "é€šç”¨æŠ€æœ¯ä¸æ€§èƒ½å‚æ•°", 
            "é€šç”¨å®éªŒæ¦‚å¿µä¸æœ¯è¯­", "æ•°å­¦ä¸ç‰©ç†ç¬¦å·", "å›½é™…å•ä½åˆ¶", "æ—¶åŸŸåˆ†ææ¦‚å¿µ", "å…¶ä»–ä¸“ä¸šæŠ€æœ¯", 
            "å†…é˜»ä¸é˜»æŠ—", "ä½å†…é˜»æµ‹é‡æ–¹æ³•", "ç”µè·¯åŸºæœ¬å…ƒä»¶ä¸åŠŸèƒ½", "ç”µä½ä¸ç”µå‹æµ‹é‡", 
            "ç”µè·¯è¿é€šæ€§æµ‹è¯•", "é€šç”¨è®¾å¤‡ä¸æ¦‚å¿µ", "ç”µè·¯ç†è®ºä¸æ•…éšœåˆ†æ"
        ],
        
        "L1_æ— æºå…ƒä»¶è¯†åˆ«": [
            "æ— æºç”µå­å…ƒä»¶ä¸è¯†åˆ«", "å¸¸ç”¨ç”µå­å…ƒå™¨ä»¶", "å¸¸ç”¨ç”µå­å…ƒå™¨ä»¶ä¸ç‰¹æ€§", "å¸¸ç”¨ç”µå­å…ƒå™¨ä»¶ç‰¹æ€§ä¸è¯†åˆ«", 
            "ç”µå­å…ƒå™¨ä»¶åˆ†ç±»ä¸è¯†åˆ«", "ç”µå­å…ƒå™¨ä»¶ç‰¹æ€§ä¸æµ‹é‡", "ç”µå­å…ƒä»¶ç‰¹æ€§ä¸è¯†åˆ«", "ç”µå­å…ƒä»¶é€šç”¨æ¦‚å¿µä¸å¤„ç†", 
            "ç”µè·¯å…ƒä»¶ç‰¹æ€§ä¸å‚æ•°", "å…ƒå™¨ä»¶è¯†åˆ«ä¸ç»“æ„", "å…ƒå™¨ä»¶é¢å®šå‚æ•°", "å…ƒå™¨ä»¶æ¸©åº¦ç‰¹æ€§", "ç”µé˜»ä¸²å¹¶è”", 
            "ç”µé˜»å™¨åŸºç¡€ä¸å‚æ•°", "ç”µé˜»å™¨ç‰¹æ€§ä¸è¯†åˆ«", "ç”µé˜»å™¨çŸ¥è¯†ä¸åº”ç”¨", "ç”µé˜»è‰²ç¯è¯†åˆ«", 
            "ç”µé˜»è‰²ç¯è¯†åˆ«ä¸é˜»å€¼è®¡ç®—", "ç”µé˜»è¯†åˆ«ä¸ç¼–ç ", "ç”µé˜»é¢œè‰²ç¼–ç ä¸æ ‡è¯†", "ç”µå®¹å™¨å‹å·ä¸æ ‡è¯†", 
            "ç”µå®¹å™¨ç‰¹æ€§ä¸åº”ç”¨", "ç”µå®¹å™¨çŸ¥è¯†ä¸åº”ç”¨", "ç”µå®¹å®¹é‡è¯†åˆ«ä¸è®¡ç®—", "ç”µå®¹ç‰¹æ€§ä¸è¯†åˆ«", 
            "ç”µå®¹ç±»å‹ä¸ç‰¹æ€§", "ç”µå®¹å™¨æ•…éšœè¯Šæ–­", "ç”µæ„Ÿå™¨ä¸é•‡æµå™¨", "ç”µæ„Ÿå™¨çŸ¥è¯†ä¸å‚æ•°", "ç”µæ„Ÿæµ‹é‡", 
            "ç”µæ„Ÿç‰¹æ€§ä¸è¯†åˆ«", "å˜å‹å™¨åŸç†ä¸ç‰¹æ€§", "å˜å‹å™¨ç©ºè½½ç‰¹æ€§", "äº’æ„Ÿçº¿åœˆåŒåç«¯è¯†åˆ«", "è€¦åˆç”µå®¹", 
            "æ’å…¥é“èŠ¯", "å…ƒä»¶ç”µå‹ç›¸ä½å·®", "å…ƒä»¶åŸºæœ¬å±æ€§ä¸åº”ç”¨", "ç”µå®¹æµ‹é‡ä¸æ£€æµ‹", "ç”µå®¹æµ‹é‡ä¸å‚æ•°", "ç”µå®¹ç”µå‹"
        ],

        "L1_æœ‰æºå™¨ä»¶ç‰¹æ€§": [
            "åŠå¯¼ä½“å™¨ä»¶ç‰¹æ€§ä¸æµ‹è¯•", "äºŒæç®¡å·¥ä½œåŸç†", "äºŒæç®¡ç‰¹æ€§", "äºŒæç®¡ç‰¹æ€§ä¸æµ‹é‡", 
            "ä¸‰æç®¡ç”µè·¯åˆ†æ", "é›†æˆç”µè·¯å¼•è„šå®šä¹‰", "é›†æˆè¿æ”¾å¼•è„š"
        ],

        "L1_ä»ªå™¨æµ‹é‡åŸç†": [
            "æµ‹é‡ä»ªå™¨ä¸æ“ä½œ", "ä¸‡ç”¨è¡¨ä¸ç”µå‹ç”µæµæµ‹é‡", "ä¸‡ç”¨è¡¨ä¸é’³å½¢è¡¨æµ‹é‡", "ä¸‡ç”¨è¡¨ä¸é’³è¡¨åº”ç”¨", 
            "ä¸‡ç”¨è¡¨ä½¿ç”¨ä¸æµ‹é‡", "ä¸‡ç”¨è¡¨æ“ä½œä¸åº”ç”¨", "ä¸‡ç”¨è¡¨æ“ä½œä¸ç‰¹æ€§", "ä¸‡ç”¨è¡¨æµ‹é‡åŠŸèƒ½", 
            "ä¸‡ç”¨è¡¨é‡ç¨‹ä¸ç²¾åº¦", "æ•°å­—ä¸‡ç”¨è¡¨äºŒæç®¡æµ‹é‡", "é’³å½¢ç”µæµè¡¨åŸç†ä¸åº”ç”¨", "æµ‹é‡ä»ªå™¨å†…é˜»", 
            "æµ‹é‡ä»ªå™¨ç²¾åº¦ä¸é‡ç¨‹", "æµ‹é‡ä»ªå™¨é€‰æ‹©", "æµ‹é‡ä»ªå™¨é€šç”¨æ“ä½œä¸å‚æ•°", "æµ‹é‡ä»ªè¡¨ä½¿ç”¨ä¸åŠŸèƒ½", 
            "ç‰¹å®šä»ªå™¨åŠŸèƒ½ä»‹ç»", "ç‰¹å®šè®¾å¤‡åŠŸèƒ½æˆ–æ˜¾ç¤º", "å¸¸ç”¨æµ‹é‡ä»ªå™¨ä¸æµ‹è¯•æŠ€æœ¯", "é€šç”¨ä»ªå™¨æ“ä½œä¸ä¿¡å·è¿æ¥", 
            "é€šç”¨ä»ªå™¨æ“ä½œä¸åé¦ˆ", "é€šç”¨ç”µå­ä»ªå™¨", "é€šç”¨æµ‹é‡å·¥å…·ä¸æ ‡è¯†", "ç”µå­å…ƒå™¨ä»¶æµ‹é‡ä»ªå™¨", 
            "æµ‹é‡æ•°æ®æ˜¾ç¤ºä¸åˆ¤è¯»", "ç”µå·¥å®éªŒå°ä½¿ç”¨", "æ¨¡å¼åˆ‡æ¢æ“ä½œ", "ç³»ç»Ÿæ“ä½œæ¨¡å¼", "åˆ·æ–°ç‡", 
            "ç”µå·¥æµ‹é‡æ–¹æ³•ä¸è¯¯å·®", "ç”µæµç”µå‹æµ‹é‡æŠ€æœ¯", "å®æ—¶æµ‹é‡è¾“å…¥ç”µå‹", "ç”µå‹ä¸ç”µæµæµ‹é‡æŠ€æœ¯", 
            "åŠŸç‡è¡¨ä½¿ç”¨ä¸æ¥çº¿", "ç”µæµæµ‹é‡ä¸åº”ç”¨"
        ],

        # ---------------- L2: æ–¹æ³•ä¸è§„èŒƒ ----------------
        "L2_å®éªŒå·¥è‰ºä¸è°ƒè¯•": [
            # åŸ[4]ä¸­å‰”é™¤å®‰å…¨ç›¸å…³ï¼ŒåŠ å…¥[13]ä¸­çš„å¸ƒçº¿ç›¸å…³ -> ä¸“æ³¨â€œåŠ¨æ‰‹èƒ½åŠ›â€
            "å®éªŒæŠ€èƒ½ä¸æ“ä½œå®è·µ", "å®éªŒæ¥çº¿ä¸å¸ƒçº¿è§„èŒƒ", "å®éªŒæ“ä½œä¸è§„èŒƒ", "å®éªŒæ“ä½œä¸è°ƒè¯•æµç¨‹", 
            "å®éªŒæ“ä½œè§„èŒƒä¸æ•…éšœæ’é™¤", "å®éªŒè°ƒè¯•ä¸æ•…éšœæ’æŸ¥", "å®éªŒè¾…åŠ©å·¥å…·ä¸ç›®çš„", "ç”µè·¯æ­å»ºä¸è°ƒè¯•", 
            "é¢åŒ…æ¿ä½¿ç”¨", "é€šç”¨å®éªŒæ“ä½œä¸æ¦‚å¿µ", "ç”µå­åˆ¶é€ ä¸è¾…åŠ©æŠ€æœ¯", "ç”µå­¦æµ‹é‡æ–¹æ³•ä¸ä»ªè¡¨",
            "ç”µæ°”æ¥çº¿è§„èŒƒä¸æ¥å£", "ç”µè·¯è¿æ¥ä¸å¸ƒå±€è§„èŒƒ", "ç”µè·¯è¿æ¥ä¸å¸ƒçº¿", "å®éªŒå®¤ç”µæºä¸ç”µè·¯æ­å»º" 
        ],

        "L2_ç”µæ°”å®‰å…¨ä¸é˜²æŠ¤": [
            # åŸ[13]ä¸»ä½“ + åŸ[4]ä¸­çš„å®‰å…¨ç›¸å…³ -> ä¸“æ³¨â€œä¿å‘½çº¢çº¿â€
            "ç”µæ°”å®‰å…¨ä¸ä¿æŠ¤", "ç”µæ°”å®‰å…¨ä¸å®éªŒè§„èŒƒ", "ç”µæ°”å®‰å…¨ä¸å¸ƒçº¿è§„èŒƒ", "ç”µæ°”å®‰å…¨ä¸åº”æ€¥å¤„ç†", 
            "ç”µæ°”å®‰å…¨ä¸æ€¥æ•‘", "ç”µæ°”å®‰å…¨ä¸æ¥åœ°", "ç”µæ°”å®‰å…¨ä¸æ¥çº¿è§„èŒƒ", "ç”µæ°”å®‰å…¨ä¸æ•…éšœå¤„ç†", 
            "ç”µæ°”å®‰å…¨ä¸ç«ç¾é˜²æŠ¤", "ç”µæ°”å®‰å…¨ä¸é˜²æŠ¤", "ç”µæ°”å®‰å…¨æ“ä½œä¸è§„èŒƒ", "ç”µè·¯è¿æ¥ä¸æ¥åœ°è§„èŒƒ", 
            "ç”µè·¯è¿æ¥ä¸æ¥çº¿è§„èŒƒ", "æ¥çº¿ä¸é…ç”µè§„èŒƒ", "è§¦ç”µäº‹æ•…ä¸æ€¥æ•‘", "éªŒç”µç¬”ä½¿ç”¨ä¸åŸç†",
            "å®éªŒå®‰å…¨ä¸æ•…éšœå¤„ç†", "å®éªŒå®¤å®‰å…¨ä¸åº”æ€¥å¤„ç½®"
        ],

        "L2_ç„Šæ¥æŠ€æœ¯å®è·µ": [
            "ç„Šæ¥ä¸æ‹†ç„ŠæŠ€æœ¯", "ç„Šæ¥ä¸è£…é…æŠ€æœ¯", "ç„Šæ¥å·¥è‰ºä¸è´¨é‡è¯„ä¼°", "ç„Šæ¥æŠ€æœ¯", "ç„Šæ¥æŠ€æœ¯ä¸æ“ä½œ", 
            "ç„Šæ¥æŠ€æœ¯ä¸è´¨é‡", "ç„Šæ¥æ“ä½œå®‰å…¨", "ç„Šæ¥æ“ä½œæŠ€å·§ä¸è´¨é‡", "ç”µå­ç„Šæ¥æŠ€æœ¯"
        ],

        "L2_æ•°æ®å¤„ç†ä¸è¯¯å·®": [
            "æµ‹é‡æ–¹æ³•ä¸æ•°æ®å¤„ç†", "æµ‹é‡æ–¹æ³•ä¸è¯¯å·®åˆ†æ", "æµ‹é‡è¯¯å·®ä¸ä¸ç¡®å®šåº¦", "æµ‹é‡è¯¯å·®ä¸å‡†ç¡®æ€§", 
            "æµ‹é‡è¯¯å·®ä¸ç‰©ç†é‡è¡¨ç¤º", "æµ‹é‡è¯¯å·®ä¸ç²¾åº¦", "æ•°æ®å¤„ç†ä¸åŸºæœ¬æ¦‚å¿µ", "é€šç”¨æµ‹é‡æ–¹æ³•"
        ],

        # ---------------- L3: ç³»ç»Ÿä¸åº”ç”¨ ----------------
        "L3_ç”µæºä¸ä¿¡å·æº": [
            # åŒ…å«äº†åŸ[5] + åŸ[1]ä¸­çš„ç”µæµæº
            "ä¾›ç”µç³»ç»Ÿä¸ç”µæ°”è¿æ¥", "ä¾›ç”µè¿‡ç¨‹ä¸ç”µå‹ç¨³å®šæ€§", "ç”µæºä¸ä¾›ç”µç³»ç»Ÿ", "ç”µæºä¸ç”µå‹ç‰¹æ€§", 
            "ç”µæºå‚æ•°ä¸ç±»å‹", "ç”µæºè®¾å¤‡ä¸ä¾›ç”µ", "ç”µæºè®¾å¤‡ä¸ä¾›ç”µç‰¹æ€§", "ç”µæºä¸ä¿¡å·è¿æ¥è§„èŒƒ", 
            "ç”µæºä¸æ¿€åŠ±ä¿¡å·", "ç”µå‹ç­‰çº§", "ä¿¡å·å‘ç”Ÿå™¨ä½¿ç”¨", "å‡½æ•°ä¿¡å·å‘ç”Ÿå™¨æ“ä½œä¸è®¾ç½®", 
            "ä¿¡å·æºä¸ä¿¡å·å‚æ•°", "ä¿¡å·æºæ“ä½œä¸è®¾ç½®", "ç›´æµç”µæºä½¿ç”¨ä¸ç‰¹æ€§", "ç›´æµç”µæºæ“ä½œä¸åŠŸèƒ½", 
            "ç›´æµç¨³å‹ç”µæºä½¿ç”¨ä¸è¿æ¥", "ç›´æµç¨³å‹ç”µæºæ“ä½œ", "ä»ªå™¨æ“ä½œç•Œé¢ä¸è°ƒè¯•", "ä»ªå™¨è¾“å…¥é˜»æŠ—åŠå…¶æ„ä¹‰", 
            "ä»ªå™¨é€šç”¨æ“ä½œä¸æ˜¾ç¤º", "ç”µæµæºç”µè·¯åŠå…¶åº”ç”¨", "å®éªŒç”µæºä¸ä¿¡å·å‘ç”Ÿå™¨"
        ],

        "L3_æ³¢å½¢åˆ†æä¸ç¤ºæ³¢å™¨": [
            # åŒ…å«äº†åŸ[6] + åŸ[1]ä¸­çš„æ³¢å½¢åˆ†æ
            "ä¿¡å·ä¸æ³¢å½¢åŸºç¡€", "ä¿¡å·å‚æ•°ä¸ç‰¹æ€§", "ä¿¡å·æ³¢å½¢ä¸å‚æ•°è®¾ç½®", "ä¿¡å·æ³¢å½¢å‚æ•°æµ‹é‡", 
            "ç¤ºæ³¢å™¨ä½¿ç”¨ä¸æ•…éšœæ’é™¤", "ç¤ºæ³¢å™¨ä½¿ç”¨ä¸æ³¢å½¢åˆ†æ", "ç¤ºæ³¢å™¨ä¿¡å·æµ‹é‡", "ç¤ºæ³¢å™¨åŸºæœ¬æ“ä½œä¸è®¾ç½®", 
            "ç¤ºæ³¢å™¨æ¢å¤´ä½¿ç”¨", "ç¤ºæ³¢å™¨æ¥åœ°ä¸æŠ—å¹²æ‰°", "ç¤ºæ³¢å™¨æ“ä½œä¸æ³¢å½¢åˆ†æ", "ç¤ºæ³¢å™¨æ“ä½œä¸æ³¢å½¢æ˜¾ç¤º", 
            "ç¤ºæ³¢å™¨æ“ä½œä¸æµ‹é‡", "ç¤ºæ³¢å™¨æ“ä½œä¸è®¾ç½®", "ç¤ºæ³¢å™¨ç±»å‹", "æ­£å¼¦æ³¢ä¿¡å·çš„ç‰¹æ€§ä¸è¾“å…¥", "ç”µä¿¡å·åŸºç¡€",
            "å…¸å‹ç”µè·¯æ³¢å½¢åˆ†æ", "äºŒé˜¶ç”µè·¯æš‚æ€å“åº”", "æŒ¯è¡å™¨åŸç†ä¸æ³¢å½¢"
        ],

        "L3_æ”¾å¤§ç”µè·¯ç³»ç»Ÿ": [
            "æ”¾å¤§å™¨ç”µè·¯åˆ†æä¸è°ƒè¯•", "æ”¾å¤§ç”µè·¯ä¸å¤±çœŸåˆ†æ", "æ”¾å¤§ç”µè·¯åˆ†æä¸è°ƒè¯•", "æ”¾å¤§ç”µè·¯åŸç†ä¸åº”ç”¨", 
            "æ”¾å¤§ç”µè·¯ç‰¹æ€§ä¸åˆ†æ", "æ”¾å¤§ç”µè·¯ç†è®ºä¸åº”ç”¨", "æ”¾å¤§ç”µè·¯è®¾è®¡ä¸ç‰¹æ€§", "è¿ç®—æ”¾å¤§å™¨åŸºç¡€çŸ¥è¯†", 
            "è¿ç®—æ”¾å¤§å™¨ç”µè·¯"
        ],

        "L3_ä¸‰ç›¸ä¸åŠŸç‡åˆ†æ": [
            # ä¸“æ³¨å¼ºç”µä¸åŠŸç‡ï¼Œå‰¥ç¦»é¢‘ç‡ç‰¹æ€§
            "ä¸‰ç›¸äº¤æµç”µè·¯", "ä¸‰ç›¸ç”µè·¯ç³»ç»Ÿä¸ç”µå‹", "ä¸‰ç›¸ç”µè·¯ç³»ç»Ÿä¸è¿æ¥", "ä¸å¯¹ç§°è´Ÿè½½åŠŸç‡æµ‹é‡ä¸è®¡ç®—", 
            "ç”µèƒ½ç®¡ç†ä¸è¡¡é‡"
        ],

        "L3_é¢‘å“ã€æ»¤æ³¢ä¸è°æŒ¯": [
            # ä¸“æ³¨é¢‘ç‡åŸŸï¼Œå¸æ”¶äº†åŸ[8]çš„é¢‘å“
            "è°æŒ¯ç”µè·¯åˆ†æ", "è°æŒ¯ç”µè·¯ç‰¹æ€§ä¸å®éªŒ", "è°æŒ¯ç”µè·¯ç‰¹æ€§ä¸åº”ç”¨", "è°æŒ¯ç”µè·¯ç‰¹æ€§ä¸æµ‹é‡", 
            "æ»¤æ³¢å™¨ä¸æ—¶é—´å¸¸æ•°", "æ»¤æ³¢å™¨åŸç†ä¸åº”ç”¨", "æ»¤æ³¢å™¨ç”µè·¯ä¸é¢‘ç‡ç‰¹æ€§", 
            "äº¤æµç”µè·¯ä¸é¢‘ç‡å“åº”ç‰¹æ€§", "äº¤æµç”µè·¯ç‰¹æ€§ä¸è®¡ç®—"
        ],

        "L3_æ•…éšœè¯Šæ–­ç»¼åˆ": [
            "æ•…éšœè¯Šæ–­ä¸æ’æŸ¥", "æ•…éšœè¯Šæ–­ä¸ç»´ä¿®", "ç”µè·¯æ•…éšœè¯Šæ–­ä¸åˆ†æ", "ç”µè·¯æ•…éšœè¯Šæ–­ä¸æ’é™¤", 
            "ç”µè·¯æ•…éšœè¯Šæ–­ä¸çŸ­è·¯ç°è±¡", "è®¾å¤‡æ˜¾ç¤ºæ•…éšœ", "å…ƒä»¶æ£€æµ‹ä¸ä»ªå™¨æ•…éšœæ’é™¤", "ç‰¹å®šç”µè·¯å®éªŒ", 
            "ç‰¹å®šç”µè·¯å®éªŒä¸ç‰¹æ€§", "ç‰¹å®šç”µè·¯åº”ç”¨ä¸å®éªŒ"
        ]
    }
    
    return mapping_rules

def validate_mapping_completeness(mapping_rules, all_knowledge_points):
    """éªŒè¯æ˜ å°„è§„åˆ™çš„å®Œæ•´æ€§ï¼ˆä¸é‡ä¸æ¼ï¼‰"""
    print("\n" + "="*60)
    print("æ˜ å°„è§„åˆ™å®Œæ•´æ€§éªŒè¯")
    print("="*60)
    
    # 1. æ”¶é›†æ‰€æœ‰è¢«æ˜ å°„çš„çŸ¥è¯†ç‚¹
    mapped_topics = []
    topic_to_category = {}  # è®°å½•æ¯ä¸ªçŸ¥è¯†ç‚¹å±äºå“ªä¸ªç±»åˆ«
    
    for category, topics in mapping_rules.items():
        for topic in topics:
            mapped_topics.append(topic)
            if topic in topic_to_category:
                topic_to_category[topic].append(category)
            else:
                topic_to_category[topic] = [category]
    
    # 2. æ£€æŸ¥ä¸é‡ï¼ˆæ¯ä¸ªçŸ¥è¯†ç‚¹åªå‡ºç°ä¸€æ¬¡ï¼‰
    print("\n1. æ£€æŸ¥çŸ¥è¯†ç‚¹æ˜¯å¦é‡å¤:")
    duplicate_topics = []
    for topic, categories in topic_to_category.items():
        if len(categories) > 1:
            duplicate_topics.append((topic, categories))
    
    if duplicate_topics:
        print(f"âŒ å‘ç° {len(duplicate_topics)} ä¸ªé‡å¤çš„çŸ¥è¯†ç‚¹:")
        for topic, categories in duplicate_topics:
            print(f"  - '{topic}' å‡ºç°åœ¨: {categories}")
    else:
        print("âœ… æ‰€æœ‰çŸ¥è¯†ç‚¹åœ¨æ˜ å°„è§„åˆ™ä¸­åªå‡ºç°ä¸€æ¬¡ï¼ˆä¸é‡ï¼‰")
    
    # 3. æ£€æŸ¥ä¸æ¼ï¼ˆæ‰€æœ‰åŸå§‹çŸ¥è¯†ç‚¹éƒ½è¢«æ˜ å°„ï¼‰
    print("\n2. æ£€æŸ¥æ˜¯å¦æœ‰çŸ¥è¯†ç‚¹æœªè¢«æ˜ å°„:")
    missing_topics = []
    for topic in all_knowledge_points:
        if topic not in topic_to_category:
            missing_topics.append(topic)
    
    if missing_topics:
        print(f"âŒ å‘ç° {len(missing_topics)} ä¸ªçŸ¥è¯†ç‚¹æœªè¢«æ˜ å°„:")
        for i, topic in enumerate(missing_topics[:20]):  # æ˜¾ç¤ºå‰20ä¸ª
            print(f"  {i+1:2d}. {topic}")
        if len(missing_topics) > 20:
            print(f"  ... è¿˜æœ‰ {len(missing_topics)-20} ä¸ªæœªæ˜¾ç¤º")
    else:
        print("âœ… æ‰€æœ‰çŸ¥è¯†ç‚¹éƒ½è¢«æ˜ å°„ï¼ˆä¸æ¼ï¼‰")
    
    # 4. æ£€æŸ¥æ˜ å°„æ˜¯å¦æœ‰é¢å¤–çŸ¥è¯†ç‚¹
    print("\n3. æ£€æŸ¥æ˜¯å¦æœ‰é¢å¤–çŸ¥è¯†ç‚¹:")
    extra_topics = []
    for topic in topic_to_category.keys():
        if topic not in all_knowledge_points:
            extra_topics.append(topic)
    
    if extra_topics:
        print(f"âš ï¸  å‘ç° {len(extra_topics)} ä¸ªé¢å¤–çš„çŸ¥è¯†ç‚¹ï¼ˆä¸åœ¨åŸå§‹åˆ—è¡¨ä¸­ï¼‰:")
        for i, topic in enumerate(extra_topics[:10]):
            print(f"  {i+1:2d}. {topic}")
        if len(extra_topics) > 10:
            print(f"  ... è¿˜æœ‰ {len(extra_topics)-10} ä¸ªæœªæ˜¾ç¤º")
    else:
        print("âœ… æ‰€æœ‰æ˜ å°„çŸ¥è¯†ç‚¹éƒ½åœ¨åŸå§‹åˆ—è¡¨ä¸­")
    
    # 5. ç»Ÿè®¡ä¿¡æ¯
    print("\n4. ç»Ÿè®¡ä¿¡æ¯:")
    print(f"  åŸå§‹çŸ¥è¯†ç‚¹æ•°é‡: {len(all_knowledge_points)}")
    print(f"  æ˜ å°„è§„åˆ™ä¸­çš„çŸ¥è¯†ç‚¹æ•°é‡: {len(mapped_topics)}")
    print(f"  æ˜ å°„è§„åˆ™ä¸­çš„å”¯ä¸€çŸ¥è¯†ç‚¹æ•°é‡: {len(set(mapped_topics))}")
    print(f"  ç›®æ ‡ç±»åˆ«æ•°é‡: {len(mapping_rules)}")
    
    # 6. æŒ‰ç±»åˆ«ç»Ÿè®¡
    print("\n5. æŒ‰ç±»åˆ«ç»Ÿè®¡çŸ¥è¯†ç‚¹æ•°é‡:")
    for category, topics in mapping_rules.items():
        print(f"  {category}: {len(topics)} ä¸ªçŸ¥è¯†ç‚¹")
    
    # 7. æ€»ä½“éªŒè¯ç»“æœ
    print("\n" + "="*60)
    if not duplicate_topics and not missing_topics and not extra_topics:
        print("ğŸ‰ æ˜ å°„è§„åˆ™éªŒè¯é€šè¿‡ï¼å®Œå¤‡ã€ä¸é‡ã€ä¸æ¼ã€‚")
        return True, topic_to_category
    else:
        print("âš ï¸  æ˜ å°„è§„åˆ™éªŒè¯æœªé€šè¿‡ï¼Œå­˜åœ¨é—®é¢˜éœ€è¦ä¿®å¤ã€‚")
        return False, topic_to_category

def apply_mapping_to_data(df, mapping_rules, knowledge_cols):
    """å°†æ˜ å°„è§„åˆ™åº”ç”¨åˆ°æ•°æ®ä¸Šï¼Œç”Ÿæˆæ–°çš„14ä¸ªç±»åˆ«åˆ—"""
    print("\n" + "="*60)
    print("å°†æ˜ å°„è§„åˆ™åº”ç”¨åˆ°æ•°æ®")
    print("="*60)
    
    # åˆ›å»ºé€†å‘æ˜ å°„ï¼šçŸ¥è¯†ç‚¹ -> ç±»åˆ«
    knowledge_to_category = {}
    for category, knowledge_list in mapping_rules.items():
        for knowledge in knowledge_list:
            knowledge_to_category[knowledge] = category
    
    # åˆå§‹åŒ–14ä¸ªç±»åˆ«åˆ—
    categories = list(mapping_rules.keys())
    for category in categories:
        df[f'{category}'] = 0
    
    # ç»Ÿè®¡ä¿¡æ¯
    mapping_stats = {category: 0 for category in categories}
    unmapped_knowledge = []
    
    # å¯¹æ¯ä¸€è¡Œåº”ç”¨æ˜ å°„
    for idx, row in df.iterrows():
        row_categories = set()
        
        # æ£€æŸ¥æ¯ä¸ªçŸ¥è¯†ç‚¹åˆ—
        for col in knowledge_cols:
            knowledge = str(row[col]).strip()
            if knowledge and knowledge.lower() not in ['nan', 'none', 'ç©º', 'null', '']:
                if knowledge in knowledge_to_category:
                    category = knowledge_to_category[knowledge]
                    row_categories.add(category)
                    mapping_stats[category] += 1
                else:
                    unmapped_knowledge.append(knowledge)
        
        # æ ‡è®°è¯¥è¡Œå±äºå“ªäº›ç±»åˆ«
        for category in row_categories:
            df.at[idx, f'{category}'] = 1
    
    # æ‰“å°ç»Ÿè®¡ä¿¡æ¯
    print("ç±»åˆ«å‡ºç°é¢‘ç‡ç»Ÿè®¡:")
    total_mapped = sum(mapping_stats.values())
    for category, count in sorted(mapping_stats.items(), key=lambda x: x[1], reverse=True):
        percentage = count / total_mapped * 100 if total_mapped > 0 else 0
        print(f"  {category}: {count}æ¬¡ ({percentage:.1f}%)")
    
    # å¤„ç†æœªæ˜ å°„çš„çŸ¥è¯†ç‚¹
    if unmapped_knowledge:
        print(f"\nâš ï¸  å‘ç° {len(set(unmapped_knowledge))} ä¸ªæœªæ˜ å°„çš„çŸ¥è¯†ç‚¹:")
        counter = Counter(unmapped_knowledge)
        for knowledge, freq in counter.most_common(10):
            print(f"  '{knowledge}': {freq}æ¬¡")
        if len(counter) > 10:
            print(f"  ... è¿˜æœ‰ {len(counter)-10} ä¸ªæœªæ˜¾ç¤º")
    
    print(f"\næ€»å…±æ˜ å°„äº† {total_mapped} ä¸ªçŸ¥è¯†ç‚¹åˆ°14ä¸ªç±»åˆ«")
    
    return df, mapping_stats, unmapped_knowledge

def analyze_category_distribution(df, categories):
    """åˆ†ææ¯ä¸ªç±»åˆ«çš„é¢˜ç›®è¦†ç›–æƒ…å†µ"""
    print("\n" + "="*60)
    print("ç±»åˆ«é¢˜ç›®è¦†ç›–åˆ†æ")
    print("="*60)
    
    category_cols = [f'{cat}' for cat in categories]
    
    # ç»Ÿè®¡æ¯ä¸ªç±»åˆ«æœ‰å¤šå°‘é¢˜ç›®
    category_counts = {}
    total_questions = len(df)
    
    for cat in categories:
        col_name = f'{cat}'
        count = df[col_name].sum()
        category_counts[cat] = count
        percentage = count / total_questions * 100
        print(f"  {cat}: {count}é¢˜ ({percentage:.1f}%)")
    
    # ç»Ÿè®¡æ¯ä¸ªé¢˜ç›®æ¶‰åŠå¤šå°‘ç±»åˆ«
    print(f"\næ¯ä¸ªé¢˜ç›®æ¶‰åŠçš„ç±»åˆ«æ•°é‡åˆ†å¸ƒ:")
    category_counts_per_question = df[category_cols].sum(axis=1)
    distribution = category_counts_per_question.value_counts().sort_index()
    
    for num_cats, count in distribution.items():
        percentage = count / total_questions * 100
        print(f"  {num_cats}ä¸ªç±»åˆ«: {count}é¢˜ ({percentage:.1f}%)")
    
    # æŸ¥æ‰¾æ¶‰åŠæœ€å¤šç±»åˆ«çš„é¢˜ç›®
    max_cats = category_counts_per_question.max()
    if max_cats > 0:
        max_questions = df[category_counts_per_question == max_cats]
        print(f"\næ¶‰åŠæœ€å¤šç±»åˆ«çš„é¢˜ç›®ï¼ˆ{max_cats}ä¸ªç±»åˆ«ï¼‰:")
        for idx, row in max_questions.head(3).iterrows():
            if 'qs_title' in df.columns:
                title = str(row['qs_title'])
                if len(title) > 40:
                    title = title[:37] + "..."
                print(f"  ID {row.get('id', idx)}: {title}")
            else:
                print(f"  ID {row.get('id', idx)}")
    
    return category_counts, category_counts_per_question

def main():
    """ä¸»å‡½æ•°ï¼šè¯»å–æ•°æ®å¹¶åº”ç”¨æ˜ å°„"""
    # 1. åŠ è½½æ˜ å°„è§„åˆ™
    print("åŠ è½½æ˜ å°„è§„åˆ™...")
    mapping_rules = load_and_validate_mapping()

    
    try:
        # è¯»å–Excelæ–‡ä»¶
        df = pd.read_excel(file_path, engine='openpyxl')
        print(f"æˆåŠŸè¯»å–æ–‡ä»¶ï¼Œå½¢çŠ¶: {df.shape}")
        
        # æ‰¾åˆ°çŸ¥è¯†ç‚¹åˆ—
        knowledge_cols = [col for col in df.columns if 'çŸ¥è¯†ç‚¹' in str(col)]
        print(f"æ‰¾åˆ°çŸ¥è¯†ç‚¹åˆ—: {knowledge_cols}")
        
        # æ”¶é›†æ‰€æœ‰çŸ¥è¯†ç‚¹
        all_knowledge_points = set()
        for col in knowledge_cols:
            col_data = df[col].dropna()
            unique_points = set(col_data.astype(str).str.strip())
            all_knowledge_points.update(unique_points)
        
        # æ¸…ç†çŸ¥è¯†ç‚¹
        all_knowledge_points = {point for point in all_knowledge_points 
                              if point and str(point).lower() not in ['nan', 'none', 'ç©º', 'null']}
        
        print(f"ä»æ•°æ®ä¸­æå–åˆ° {len(all_knowledge_points)} ä¸ªçŸ¥è¯†ç‚¹")
        
        # 3. éªŒè¯æ˜ å°„è§„åˆ™çš„å®Œæ•´æ€§
        is_valid, topic_to_category = validate_mapping_completeness(mapping_rules, all_knowledge_points)
        
        if not is_valid:
            print("\nâš ï¸ æ˜ å°„è§„åˆ™å­˜åœ¨é—®é¢˜ï¼Œè¯·å…ˆä¿®å¤åå†ç»§ç»­")
            return
        
        # 4. å°†æ˜ å°„åº”ç”¨åˆ°æ•°æ®
        df_with_categories, mapping_stats, unmapped = apply_mapping_to_data(df, mapping_rules, knowledge_cols)
        
        # 5. åˆ†æç±»åˆ«åˆ†å¸ƒ
        categories = list(mapping_rules.keys())
        category_counts, category_counts_per_question = analyze_category_distribution(df_with_categories, categories)
        
        # 6. ä¿å­˜ç»“æœ
        output_file = f"{file_path.rsplit("/",1)[0]}/QçŸ©é˜µ_æ‰‹å·¥æ ‡æ³¨åˆå¹¶14ä¸ª.xlsx"
        df_with_categories.to_excel(output_file, index=False)
        print(f"\nâœ… ç»“æœå·²ä¿å­˜åˆ°: {output_file}")
        
        # 7. ç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        print("\n" + "="*60)
        print("æ˜ å°„åº”ç”¨æ€»ç»“")
        print("="*60)
        print(f"åŸå§‹é¢˜ç›®æ•°: {len(df)}")
        print(f"åŸå§‹çŸ¥è¯†ç‚¹æ•°: {len(all_knowledge_points)}")
        print(f"ç›®æ ‡ç±»åˆ«æ•°: {len(categories)}")
        
        # æ£€æŸ¥æ˜¯å¦æœ‰é¢˜ç›®æ²¡æœ‰æ˜ å°„åˆ°ä»»ä½•ç±»åˆ«
        no_category_questions = (category_counts_per_question == 0).sum()
        if no_category_questions > 0:
            print(f"âš ï¸  æœ‰ {no_category_questions} ä¸ªé¢˜ç›®æ²¡æœ‰æ˜ å°„åˆ°ä»»ä½•ç±»åˆ«")
        
        # æ£€æŸ¥ç±»åˆ«è¦†ç›–æƒ…å†µ
        print(f"\nç±»åˆ«è¦†ç›–æƒ…å†µ:")
        for cat, count in sorted(category_counts.items(), key=lambda x: x[1], reverse=True):
            percentage = count / len(df) * 100
            if count == 0:
                print(f"  âš ï¸  {cat}: {count}é¢˜ (0%) - æœªä½¿ç”¨")
            elif percentage < 5:
                print(f"  ğŸ“Š {cat}: {count}é¢˜ ({percentage:.1f}%) - è¾ƒå°‘ä½¿ç”¨")
            else:
                print(f"  âœ… {cat}: {count}é¢˜ ({percentage:.1f}%)")
        
    except Exception as e:
        print(f"å¤„ç†æ–‡ä»¶æ—¶å‡ºé”™: {e}")
        import traceback
        print(traceback.format_exc())

if __name__ == "__main__":
    main()